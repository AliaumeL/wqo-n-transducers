\documentclass[11pt]{article}

\input{lib/packages}     % packages needed for this paper
\input{lib/aliaume}      % aliaumeâ€™s custom macros

\input{lib/maths}        % custom math commands specific to this paper
\input{knowledges.kl}    % textual knowledges

\input{src/metadata.tex} % metadata of the paper (generated)


\begin{document}
\maketitle
\makeabstract

% main content


\section{Beyond commutativity}
\label{beyond-commutative:sec}

\AP The goal of this section is to introduce new tools that do not require the
assumption of \kl{commutativity}. To that end, we propose a notion of
\kl{$k$-residual transducer}, that generalizes the notion of residual
transducer introduced for \kl{$\Rel$-polyregular functions} in \cite{CDTL23}.
This is done by shifting the attention from (compatible) equivalence relations
of finite index that are the classical tool in automata theory, towards
(compatible) order relations that are \kl{well-quasi-ordered}, which is the
order counterpart of having finite index. Let us recall that a sequence
$\seqof{u_i}{i \in \Nat}$ of elements in a quasi-ordered set $(X, \leq)$ is
\intro{good} whenever there exist $i < j$ such that $u_i \leq u_j$. The set $X$
is a \intro{well-quasi-ordering} when every infinite sequence is
\kl{good}. A sequence is \intro{bad} when it is not \kl{good}. The
notion of \kl{good sequences} can also be applied to binary relations that
are not orderings, and a binary relation $R$ for which every infinite sequence
is \kl{good} is said to be \intro{well} \cite{MELL98}.

\AP The core concept of this section is that of a \intro{residual} of a
function $f \colon \Sigma^* \to \Rel$,  defined by $\intro*\app{f}{u} \defined
w \mapsto f(uw)$. The collection of \kl{residuals} of a function $f$ is
denoted $\intro*\Res(f)$ and is defined as the set of $\app{f}{u}$
where $u$ ranges over words in $\Sigma^*$. Given $k \in \Nat$, we define $f
\intro*\zpolyequiv[k] g$ if and only if $(g - f) \in \ZPoly[k-1]$, and $f
\intro*\npolyleq[k] g$ if and only if $(g - f) \in \NPoly[k-1]$. The spaces of
interest for a function $f \in \ZPoly[k]$ will be $(\Res(f),
\zpolyequiv[k])$, and $(\Res(f), \npolyleq[k])$. However, to
simplify notations, instead of writing $\app{f}{u} \npolyleq[k]
\app{f}{v}$ when $u,v \in \Sigma^*$, we will use the convenient notation $u
\intro*\resleq{f}{k} v$, and directly consider the space $(\Sigma^*,
\resleq{f}{k})$. 


\AP Given a function $f$, our goal is to leverage $\resleq{f}{k}$ to build a
canonical \kl{$\NPoly[k-1]$-transducer} that \kl{computes} $f$. The idea is to
consider as states the minimal elements of $\Sigma^*$ for $\resleq{f}{k}$, and
define transitions by letting $\delta(u, a)$ be some state $v$ such that $v
\resleq{f}{k} ua$. To produce a canonical model, this has to be done carefully,
as illustrated by the two distinct \kl{$\NPoly[0]$-transducers} of
\cref{non-canonical-transd:fig} computing the function $\BadExOk$ of
\cref{non-canonical-transd:ex}, and having as states minimal elements for
$\resleq{\BadExOk}{0}$. To ensure unicity, we ask that the set of states is a
\intro{downwards closed} subset of $\Sigma^*$ for the \intro{prefix ordering}
$(\intro*\prefleq)$, i.e. that every prefix of a state is also a state. 

\begin{definition}
    \label{residual-transducer:def}
    Let $f \colon \Sigma^* \to \Nat$ and $k \in \Nat$.
    A transducer $\aTransd \defined (Q, q_0, \delta, \lambda, F)$
    is a \intro{$k$-residual transducer}
    of $f$ 
    when
    it is a \kl{$\NPoly[k-1]$-transducer}
    satisfying the following properties:
    \begin{enumerate}
        \item $\aTransd$ \kl{computes} $f$;
        \item $Q \subseteq \Sigma^*$ is a \kl{downwards closed}
            for $\prefleq$;
        \item $q_0 = \varepsilon$;
        \item every state $q \in Q$ is accessible from $q_0$;
        \item For all $u, a \in Q$,
            $\delta(u,a)$ is the $\prefleq$-maximal $v \in Q$
            such that $v \prefleq ua$, and $v \resleq{f}{k} ua$.
        \item For all $u,a \in Q$,
            $\lambda(u,a) = (\app{f}{ua} - \app{f}{\delta(u,a)}) \in \NPoly[k-1]$.
    \end{enumerate}
\end{definition}


Let us now introduce \cref{residual:algo} to compute the \kl{$k$-residual
transducer} given a function $f$. Notice that this algorithm requires the
ability to test if a function belongs to $\NPoly[k]$, which is only known to be
feasible for \kl{commutative} \kl{polyregular functions}. However, the
termination of this algorithm also proves the existence of the \kl{$k$-residual
transducer}. The key argument proving the termination of \cref{residual:algo}
is based on the fact that for a function $f \in \NPoly[k]$, the quasi-ordering
$(\resleq{f}{k})$ is a \kl{well-quasi-ordering}. This connection is made
possible through the characterization of $\NPoly$ as counting the number of
valuations of some $\MSO$ formulas \cite{KRRC13,CDTL23}.

\begin{algorithm}[t]
    $Q \defined \{ \varepsilon \}$;
    $O \defined \setof{ a }{ a \in \Sigma}$;
    $\delta \defined \emptyset$;
    $\lambda \defined \emptyset$;
    $F \defined \emptyset$;

    \While{$O \neq \emptyset$}{
        choose $ua \in O$;

        $O \defined O \setminus \set{ ua }$;

        \eIf{$\exists v \in Q, v = \max_{\prefleq} \setof{w \in Q}{w \prefleq ua \wedge w \resleq{f}{k} ua}$}{
            $\delta(u, a) \defined v$;
            $\lambda(u, a) \defined \app{f}{ua} - \app{f}{v}$;
        }{
            $Q \defined Q \uplus \set{ ua }$;
            $\delta(u,a) \defined ua$;
            $\lambda(u,a) \defined 0$;
            $O \defined O \cup \setof{ uab }{b \in \Sigma}$;
        }
    }
    \For{$u \in Q$}{
        $F(u) \defined f(u)$;
    }
    \Return{$(Q, \varepsilon, \delta, \lambda, F)$};
    \caption{Computing a $k$-residual transducer given a function $f$.}
    \label{residual:algo}
\end{algorithm}


\begin{theorem}
    \label{non-commutative-npoly:thm}
    Let $f \in \ZPoly$ be a non-negative function, 
    and $k \in \Nat$,
    the following are equivalent:
    \begin{enumerate}
        \item \label{n-poly-1-transd:item} $f$ is \kl{computed}
            by a \kl{$\NPoly[k-1]$-transducer};
        \item \label{n-poly-k:item} $f \in \NPoly[k]$;
        \item \label{n-poly-wqo:item} $(\Sigma^*, \resleq{f}{k})$ is a
            \kl{well-quasi-ordering};
        \item \label{n-poly-well:item} every $\prefleq$-increasing sequence
            of $\Sigma^*$  is a \kl{good sequence}
            for $\resleq{f}{k}$;
        \item \label{n-poly-residual:item} The
            \kl{$k$-residual transducer}
            of 
            $f$ exists.
    \end{enumerate}
    If $f$ is \kl{commutative}, the  
    properties are decidable, and the conversions effective.
    \proofref{non-commutative-npoly:thm}
\end{theorem}

\AP Unfortunately, the \kl{residual transducer} does not seem to provide an
algorithm to decide $\NSF$ inside $\NPoly$ in the general setting. While we can
prove that for functions in $\NPoly[0]$, aperiodicity is equivalent to the
absence of counters in the \kl{residual transducer} of the function (see
\cref{aperiodic-iff-residual:lem}), this result does not generalize to higher
growth rates, as witnessed by \cref{non-aperiodic-residual-transd:ex}, which
suggests that a more sophisticated object is needed to observe aperiodicity. In
the spirit of the characterization of $\NPoly$ based the $(\resleq{f}{k})$
quasi-ordering (\cref{non-commutative-npoly:thm}), we introduce the notion of
\intro{aperiodic ordering} of $\Sigma^*$ as follows: $(\Sigma^*, \leq)$ is
\reintro[aperiodic ordering]{aperiodic} whenever for all $u, w \in \Sigma^*$,
there exists $N_0 \in \Nat$, such that the sequence $\seqof{uw^n}{n \geq N_0}$
is increasing. This leads to the following
\cref{sf-no-periods-on-sequences:conj}, of which the easy implication is
already known to hold (\cref{sf-no-periods-on-sequences:lemma}), and requires
the introduction of the \emph{star-free variant} $(\intro*\resleqsf{f}{k})$ of
$(\resleq{f}{k})$, defined by $u \reintro*\resleqsf{f}{k} v$ whenever
$(\app{f}{v} - \app{f}{u}) \in \NSF[k-1]$.
 


\begin{lemma} 
    \label{aperiodic-iff-residual:lem}
    Let $f \in \NPoly[0]$. Then,
    $f \in \NSF$ if and only if 
    $f \in \ZSF$, if and only if
    $f$ is \kl{ultimately polynomial}, if and only if 
    the \kl{$0$-residual transducer} of $f$ is \kl{counter-free}.
    \proofref{aperiodic-iff-residual:lem}
\end{lemma}

\begin{example}
    \label{non-aperiodic-residual-transd:ex}
    Let us define
    $\BadExKo(\varepsilon) = 1$,
    $\BadExKo(a) = 0$,
    $\BadExKo(a^2) = 1$,
    and $\BadExKo(a^n) = n - 3$ for all $n \geq 3$.
    The \kl{$0$-residual transducer} of $\BadExKo$ has a \kl{counter} and two states.
    Furthermore,
    every \kl{$\NPoly[0]$-transducer} with two states contains a \kl{counter}.
\end{example}


\begin{lemma}
    \label{sf-no-periods-on-sequences:lemma}
    Let $k \in \Nat$, and $f \in \NPoly[k]$. If $f \in \NSF[k]$, then
    $(\Sigma^*, \resleqsf{f}{k})$ is an
    \kl[aperiodic ordering]{aperiodic} \kl{well-quasi-ordering}.
    \proofref{sf-no-periods-on-sequences:lemma}
\end{lemma}

\begin{conjecture}
    \label{sf-no-periods-on-sequences:conj}
    The implication of \cref{sf-no-periods-on-sequences:lemma} is actually an equivalence.
    %For all $k \in \Nat$ and $f \colon \Sigma^* \to \Rel$,
    %$f \in \NSF[k]$ if and only if $(\Sigma^*, \resleqsf{f}{k})$ is an \kl[aperiodic ordering]{aperiodic}
    %\kl{well-quasi-ordering}.
\end{conjecture}

% bibliographies
\bibliographystyle{plainurl}
\bibliography{papers.bib}

% appendices
\appendix

\end{document}
