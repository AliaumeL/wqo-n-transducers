%! TeX program = xelatex 
%! TeX root = wpreg.tex
\documentclass[11pt]{article}

\input{lib/packages}     % packages needed for this paper
\input{lib/aliaume}      % aliaume’s custom macros

\input{lib/maths}        % custom math commands specific to this paper
\input{knowledges.kl}    % textual knowledges

\input{src/metadata.tex} % metadata of the paper (generated)

\usepackage{lineno}
\linenumbers


\begin{document}
\maketitle
\makeabstract

% main content

\section{Introduction}
\label{intro:sec}

Polyregular functions were introduced by Bojańczyk \cite{BOJA18} as class of
functions that aims to generalize the robust notion of regular languages to
string-to-string functions. One particular restriction of polyregular functions
has gotten a lot of attention in the literature: the unary output polyregular
functions. These were a central topic of the work of Douéneau-Tabot in his
Ph.D. thesis \cite{DOUE23}, proving optimisation results \cite{DOUE21}
\cite{DOUE22}. 

\begin{itemize}
    \item Note that unary output polygegular function form a subclass of
          what is more well-known as ($\Nat$) \emph{(noncommutative) rational series},
          that is functions from $\Sigma^*$ to $\Nat$ computed by $\Nat$-weigthed
          automata \cite{BERE88,BERE10}. This was already noticed by \cite{SCHU62}.
    \item The unary output polyregular functions can also be understood as 
          a form of counting MSO queries \cite{KRRC13}.
\end{itemize}

Like regular languages, polyregular functions enjoy a rich algebraic structure,
and there exists a \emph{star-free} restriction of polyregular functions that
corresponds to \emph{first order definable} functions. It was with the aim of
deciding the membership problem of star-free polyregular functions inside
polyregular functions that Colcombet, Douéneau-Tabot, and Lopez introduced in
\cite{CDTL23} the notion of $\Rel$-polyregular functions. The decidability of
the membership problem for star-free $\Rel$-polyregular functions inside
$\Rel$-polyregular functions was proven using a notion of \emph{residual
transducer}, a computation model that is powered by computing differences of
functions. 


\paragraph{Contributions.} This paper extends the notion of \emph{residual
transducer} from $\Rel$-polyregular functions to $\Nat$-polyregular functions,
effectively providing a new canonical object associated to polyregular
functions with unary output. This is done by shifting the attention from
equivalence relations of finite index, that are the classical tool in automata
theory, towards order relations that are well-quasi-ordered, which is the order
counterpart of having finite index. 

\AP Let us now introduce the necessary tools on \emph{well-quasi-orderings}
that will be used in the sequel. A sequence $\seqof{u_i}{i \in \Nat}$ of
elements in a quasi-ordered set $(X, \leq)$ is \intro{good} whenever there
exist $i < j$ such that $u_i \leq u_j$. The set $X$ is a
\intro{well-quasi-ordering} when every infinite sequence is \kl{good}. A
sequence is \intro{bad} when it is not \kl{good}. The notion of \kl{good
sequences} can also be applied to binary relations that are not orderings, and
a binary relation $R$ for which every infinite sequence is \kl{good} is said to
be \intro{well} \cite{MELL98}. The class of \kl{well-quasi-orderings} contains
$(\Nat, \leq)$, and is closed under taking finite products.

\paragraph{Outline.}



\section{Preliminaries}
\label{preliminaries:sec}

We assume that the reader is familiar with the basics of automata theory and
formal languages. 

Let us first recall the definition of a \emph{polyregular function} in the
commutative output case, that is the definition of respectively
$\Nat$-polyregular functions and $\Rel$-polyregular functions.

\begin{definition}
    \label{polyregular-function:def}
    Let $\mathbb{S}$ be a semiring.
    A function $f \colon \Sigma^* \to \mathbb{S}$ is \intro{polyregular} if
    there exists a finite set of $\MSO$-formulas $\varphi_1, \ldots, \varphi_n$
    with first-order free variables $\vec{x}$, and a finite set of
    constants $c_1, \ldots, c_n \in \mathbb{S}$, such that
    for all $w \in \Sigma^*$:
    \begin{equation*}
        f(w) = \sum_{i=1}^n c_i \cdot \text{count}(\varphi_i, w),
    \end{equation*}
    Where $\text{count}(\varphi_i, w)$ is the number of valuations of $\vec{x}$
    that satisfy $\varphi_i$ in the word $w$.

    The function $f$ is \intro{star-free} if the formulas $\varphi_i$ are
    in $\FO$.
\end{definition}

\AP Let us now recall the fundamental optimisation theorem of polyregular
functions, that relate the minimal number of free variables needed to describe
a polyregular function to the so-called \emph{growth rate} of the function. The
\intro{growth} of a function $f \colon \Sigma^* \to \mathbb{S}$ (where
$\mathbb{S} \subseteq \Real$) is the function $g \colon \Nat \to \Real$ defined
by $\text{growth}_f(n) = \max \setof{f(w)}{w \in \Sigma^{\leq n}}$. A function
$f$ has \intro{growth rate} $k \in \Nat$ if there exists a constant $c \in
\mathbb{S}$ such that for all $n \in \Nat$, $\text{growth}_f(n) \leq c \cdot
n^k$, i.e., if $\text{growth}_f(n) = \bigO{n^k}$.

\begin{theorem}
    \label{optimisation-theorem:thm}
    Let $f \colon \Sigma^* \to \Nat$ (resp. $\Rel$) be a (star-free) polyregular function. Then 
    $f$ has \kl{growth rate} $k$ if and only if 
    $f$ is computable by a (star-free) polyregular function using at most $k$ free variables.
\end{theorem}

\AP Let us write $\intro*\NPoly[k]$ for the set of functions $f \colon \Sigma^*
\to \Rel$ that are computable by an $\MSO$-formula using at most $k$ free
variables, and $\intro*\ZPoly[k]$ for the set of functions $f \colon \Sigma^*
\to \Nat$ that are computable by an $\MSO$-formula using at most $k$ free
variables. The analogue notions of $\NSF[k]$ and $\ZSF[k]$ are defined for
star-free functions. 

Another important result on (commutative output) polyregular functions is the
existence of an equivalent model of computation based on the notion of
\emph{$\mathcal{H}$-transducer}. To illustrate the idea behind these
transducers, let us remark that for any function $f \colon \Nat \to \Rel$,
$f(n) = \sum_{i=0}^{n-1} \Delta_f (i) + f(0)$, where $\Delta_f(i) = f(i+1) -
f(i)$ is the \emph{discrete derivative} of $f$ at $i$. Remark that a function
$f$ is a polynomial if and only if recursively computing the discrete
derivative of $f$ eventually leads to a constant function. 

\begin{definition}
    \label{oracle-transducer:def}
    Let $\mathcal{H} \subseteq \Rel^{\Sigma^*}$ be a set of
    functions. An \intro{$\mathcal{H}$-transducer}
    is a tuple $\aTransd \defined (Q, q_0, \delta, \lambda, F)$
    where
    \begin{itemize}
        \item $Q$ is a finite set of states,
        \item $q_0 \in Q$ is called the initial state,
        \item $\delta \colon Q \times \Sigma \to Q$ is called the transition function,
        \item $\lambda \colon Q \times \Sigma \to \mathcal{H}$ is called the derivative function,
        \item $F \colon Q \to \Rel$ is called the final condition.
    \end{itemize}
\end{definition}

\AP
The semantics of an $\mathcal{H}$-transducer is defined by induction
as follows: for all $q \in Q$, $a \in \Sigma$, and $w \in \Sigma^*$,
$\aTransd(q, aw) = \aTransd(\delta(q,a), w) + \lambda(q, a)(w)$ and 
$\aTransd(q, \varepsilon) = F(q)$.
That is, given a word $w$
\begin{equation*}
    \aTransd(q_0, w) 
    = \sum_{i=0}^{|w|-1} \lambda(\delta^*(q_0, w_{\leq i}), w_{i+1})(w_{> i+1}) + F(\delta^{|w|}(q_0, \varepsilon))
    \quad 
    .
\end{equation*}

In that sense, the $\mathcal{H}$-transducer is really computing a \emph{noncommutative integral}
of the function $\lambda$ with (final) condition $F$.
The fundamental integration theorem for polyregular functions can be stated as follows.
\begin{theorem}
    \label{H-transducers:thm}
    Let $f \colon \Sigma^* \to \Rel$ (resp. $\Nat$) be a function and $k \geq 1$.
    $f \in \NPoly[k]$ (resp. $\ZPoly[k]$, $\ZSF[k]$, $\NSF[k]$) if and only if
    if and only if 
    $f$ is computed by an $\NPoly[k-1]$-transducer
    (resp. $\ZPoly[k-1]$, $\ZSF[k-1]$, $\NSF[k-1]$).
\end{theorem}

\begin{example}
    \label{non-canonical-transd:ex}
    TODO.
\end{example}
\begin{proofof}{non-canonical-transd:ex}
    Let us prove that the transducer of
    \cref{non-canonical-transd:fig:counter-free}
    computes $f$.
    We prove by induction on $w$
    that $A(q_0, w) = f(w)$,
    and that $A(q_1, w) = f(aw)$.
    To that end, let us first remark that $f(\varepsilon) = 1$,
    and $f(au) = \card{u}$.
    
    When $w = \varepsilon$, $A(q_0, \varepsilon) = F(\varepsilon) = 1 = f(\varepsilon)$.
    Similarly, $A(q_1, \varepsilon) = F(q_1) = 0 = f(a)$.

    Assume that $w = au$. Then:
    \begin{align*}
        A(q_0, w) = A(q_0, au) &= \lambda(q_0, a)(u) + A(q_1, u) \\ 
                               &= 0 + A(q_1,u) \\
                               &= f(au) & \text{by induction hypothesis} \\
                               &= f(w) 
    \end{align*}
    Similarly,
    \begin{align*}
        A(q_1, w) = A(q_1, au) &= \lambda(q_1, a)(u) + A(q_1, u) \\ 
                               &= 1 + A(q_1,u) \\
                               &= 1 + f(au) & \text{by induction hypothesis} \\
                               &= 1 + \card{u} \\
                               &= \card{au} \\
                               &= f(aau) \\
    \end{align*}

    The proof for the other automaton is similar. The
    key ingredient in the induction hypothesis is that if $\card{u} \geq 1$, then:
    $f(au) - f(u) = 1$ and otherwise $f(a) - f(\varepsilon) = -1$.
    Hence, $f(au) - f(u) = 1 - 2 \times \ind{\card{u} = 0} = \lambda(q_1, a)(u)$.
\end{proofof}

\section{Residual Transducers}
\label{residual-transducer:sec}

\AP The core concept of this section is that of a \intro{residual} of a
function $f \colon \Sigma^* \to \Rel$,  defined by $\intro*\app{f}{u} \defined
w \mapsto f(uw)$. The collection of \kl{residuals} of a function $f$ is
denoted $\intro*\Res(f)$ and is defined as the set of $\app{f}{u}$
where $u$ ranges over words in $\Sigma^*$. Given $k \in \Nat$, we define $f
\intro*\zpolyequiv[k] g$ if and only if $(g - f) \in \ZPoly[k-1]$, and $f
\intro*\npolyleq[k] g$ if and only if $(g - f) \in \NPoly[k-1]$. The spaces of
interest for a function $f \in \ZPoly[k]$ will be $(\Res(f),
\zpolyequiv[k])$, and $(\Res(f), \npolyleq[k])$. However, to
simplify notations, instead of writing $\app{f}{u} \npolyleq[k]
\app{f}{v}$ when $u,v \in \Sigma^*$, we will use the convenient notation $u
\intro*\resleq{f}{k} v$, and directly consider the space $(\Sigma^*,
\resleq{f}{k})$. 


\AP Given a function $f$, our goal is to leverage $\resleq{f}{k}$ to build a
canonical \kl{$\NPoly[k-1]$-transducer} that \kl{computes} $f$. The idea is to
consider as states the minimal elements of $\Sigma^*$ for $\resleq{f}{k}$, and
define transitions by letting $\delta(u, a)$ be some state $v$ such that $v
\resleq{f}{k} ua$. To produce a canonical model, this has to be done carefully,
as illustrated by the two distinct \kl{$\NPoly[0]$-transducers} of
\cref{non-canonical-transd:fig} computing the function $\BadExOk$ of
\cref{non-canonical-transd:ex}, and having as states minimal elements for
$\resleq{\BadExOk}{0}$. To ensure unicity, we ask that the set of states is a
\intro{downwards closed} subset of $\Sigma^*$ for the \intro{prefix ordering}
$(\intro*\prefleq)$, i.e. that every prefix of a state is also a state. 

\begin{remark}
    \label{good-residual-ordering:fact}
    Let $k \in \Nat$, and let $f \colon \Sigma^* \to \Nat$. Then,
    $(\resleq{f}{k})$ is a quasi-ordering, satisfying the following
    extra properties:
    \begin{enumerate}
        \item For all $u,v,w \in \Sigma^*$, $u \resleq{f}{k} v$
            implies $uw \resleq{f}{k} vw$,
        \item If $u \resleq{f}{k} v$ and $v \resleq{f}{k} u$,
            then $\app{f}{u} = \app{f}{v}$.
    \end{enumerate}
\end{remark}

\begin{definition}
    \label{residual-transducer:def}
    Let $f \colon \Sigma^* \to \Nat$ and $k \in \Nat$.
    A transducer $\aTransd \defined (Q, q_0, \delta, \lambda, F)$
    is a \intro{$k$-residual transducer}
    of $f$ 
    when
    it is a \kl{$\NPoly[k-1]$-transducer}
    satisfying the following properties:
    \begin{enumerate}
        \item $\aTransd$ \kl{computes} $f$;
        \item $Q \subseteq \Sigma^*$ is a \kl{downwards closed}
            for $\prefleq$;
        \item $q_0 = \varepsilon$;
        \item every state $q \in Q$ is accessible from $q_0$;
        \item For all $u, a \in Q$,
            $\delta(u,a)$ is the $\prefleq$-maximal $v \in Q$
            such that $v \prefleq ua$, and $v \resleq{f}{k} ua$.
        \item For all $u,a \in Q$,
            $\lambda(u,a) = (\app{f}{ua} - \app{f}{\delta(u,a)}) \in \NPoly[k-1]$.
    \end{enumerate}
\end{definition}

\begin{fact}
    \label{unique-res-transducer:fact}
    Let $f \colon \Sigma^* \to \Nat$ and $k \in \Nat$.
    Then $f$ has at most one \kl{$k$-residual transducer}.
\end{fact}
\begin{proof}
    Let $\aTransd_1$ and $\aTransd_2$ be two
    \kl{$k$-residual transducers} for $f$.
    The two initial states must be $\varepsilon$.
    Let us prove by induction on $u \in \Sigma^*$ that
    $\delta_1(\varepsilon, u) = \delta_2(\varepsilon, u)$
    and that $Q_1$ equals $Q_2$ over prefixes of $u$.
    This will prove that 
    $Q_1 = Q_2$, hence that $\aTransd_1 = \aTransd_2$.

    Let $u \in \Sigma^* \cap Q_1 \cap Q_2$ and $a \in \Sigma$, $v_1 \in Q_1$ be
    defined as $v \defined \delta_1(u,a)$, and $v_2 \defined \delta_2(u,a)$.
    Remark that by induction hypothesis, for all $v \prefle u$, $v \in Q_1 \cap
    Q_2$. If $\delta_1(u,a) = Q_1$, it means that for all $v \in Q_2$ such that
    $v \prefle ua$, we have $\neg( v \resleq{f}{k} ua )$. The only possible
    transition in $\aTransd_2$ is therefore $\delta_2(u,a) = ua$, and $ua \in
    Q_2$. Similarly, if $\delta_1(u,a) \prefleq u$, then $\delta_2(u,a) =
    \delta_1(u,a)$ by definition of $\delta_2$ as a maximum.
\end{proof}

Let us now introduce \cref{residual:algo} to compute the \kl{$k$-residual
transducer} given a function $f$. Notice that this algorithm requires the
ability to test if a function belongs to $\NPoly[k]$, which is only known to be
feasible for \kl{commutative} \kl{polyregular functions}. However, the
termination of this algorithm also proves the existence of the \kl{$k$-residual
transducer}. The key argument proving the termination of \cref{residual:algo}
is based on the fact that for a function $f \in \NPoly[k]$, the quasi-ordering
$(\resleq{f}{k})$ is a \kl{well-quasi-ordering}. This connection is made
possible through the characterization of $\NPoly$ as counting the number of
valuations of some $\MSO$ formulas \cite{KRRC13,CDTL23}.

\begin{algorithm}[t]
    $Q \defined \{ \varepsilon \}$;
    $O \defined \setof{ a }{ a \in \Sigma}$;
    $\delta \defined \emptyset$;
    $\lambda \defined \emptyset$;
    $F \defined \emptyset$;

    \While{$O \neq \emptyset$}{
        choose $ua \in O$;

        $O \defined O \setminus \set{ ua }$;

        \eIf{$\exists v \in Q, v = \max_{\prefleq} \setof{w \in Q}{w \prefleq ua \wedge w \resleq{f}{k} ua}$}{
            $\delta(u, a) \defined v$;
            $\lambda(u, a) \defined \app{f}{ua} - \app{f}{v}$;
        }{
            $Q \defined Q \uplus \set{ ua }$;
            $\delta(u,a) \defined ua$;
            $\lambda(u,a) \defined 0$;
            $O \defined O \cup \setof{ uab }{b \in \Sigma}$;
        }
    }
    \For{$u \in Q$}{
        $F(u) \defined f(u)$;
    }
    \Return{$(Q, \varepsilon, \delta, \lambda, F)$};
    \caption{Computing a $k$-residual transducer given a function $f$.}
    \label{residual:algo}
\end{algorithm}

\begin{fact}
    \label{q-o-prefix-cool:fact}
    Let $f \colon \Sigma^* \to \Nat$ and $k \in \Nat$.
    At each step of the \texttt{while loop}
    of \cref{residual:algo}, the sets
    $Q$ and $O$ are such that
    \begin{enumerate}
        \item $Q \cup O$ is a \kl{downwards closed} subset of 
            $\Sigma^*$ for $\prefleq$;
        \item elements in $O$ are pairwise incomparable
            for $\prefleq$, and are maximal
            for $\prefleq$ inside $Q \cup O$.
    \end{enumerate}
\end{fact}
\begin{proof}
    Let us write $Q_i$ and $O_i$ for the value of the variables
    $Q$ and $O$ at step $i$ of the \texttt{while loop}.
    We prove the desired property by induction on $i$.

    For $i=0$, the property is true because
    $Q_0 = \set{\varepsilon}$ and $O_0 = \setof{a}{a \in \Sigma}$.

    For $i+1$. Either the \texttt{if} branch was taken, in which case $Q_{i+1}
    \cup O_{i+1} = (Q_i \cup O_i) \setminus \set{u}$ for some $u \in O_i$. This
    set remains \kl{downwards closed}, and elements in $O_{i+1}$ remain maximal
    elements. 

    If the \texttt{else} branch was taken, then there exists $u \in O_i$ such
    that $Q_{i+1} = Q_i \cup \set{u}$ and $O_{i+1} = O_i \setminus \set{ u }
    \cup \setof{ ua }{ a \in \Sigma}$. We conclude that $Q_{i+1} \cup O_{i+1} =
    Q_i \cup O_i \cup \setof{ ua }{a \in \Sigma}$ continues to be \kl{downwards
    closed} for $\prefleq$. Let $v \in Q_{i+1} \cup O_{i+1}$ be such that $ua
    \prefleq v$ for some $a \in \Sigma$. Then $u \prefleq v$, and $u = v$ since
    $u$ was a maximal element. As a consequence, $ua$ is a maximal element for
    all $a \in \Sigma$. Assume by contradiction that $ua$ is comparable with
    some $v \in O_{i+1}$ with $ua \neq v$, it cannot be that $ua \prefleq v$ by
    the above argument, and if $v \prefleq ua$ with $v \neq ua$, then $v
    \prefleq u$ and $u = v$, which is absurd since $v \not \in O{i+1}$.
    We have concluded that $O_{i+1}$ continues to have pairwise incomparable
    elements.
\end{proof}


\begin{lemma}
    \label{correct-residual:lemma}
    If \cref{residual:algo} terminates on 
    an input $f \colon \Sigma^* \to \Nat$, $k \in \Nat$,
    then it computes the \kl{$k$-residual transducer} of $f$.
    \proofref{correct-residual:lemma}
\end{lemma}
\begin{proof}
    Because of \cref{q-o-prefix-cool:fact},
    we already know that $q_0 = \varepsilon$,
    $Q$ is a \kl{downwards closed} subset of $\Sigma^*$
    for $\prefleq$, 
    that every state of $Q$ is accessible from $q_0$.
    Notice that at every step,
    $\lambda(u,a)$ is defined as
    $\app{f}{ua} - \app{f}{\delta(u,a)}$.
    Finally, since $Q \cup O$ is a \kl{downwards closed} subset of $\Sigma^*$
    at every step,
    we have that at step $i$,
    for all $ua \in O_i$,
    $\setof{w \in Q}{w \prefleq ua} = \setof{w \in Q_i}{ w \prefleq ua}$,
    which proves that the maximum considered in the algorithm
    is indeed computing correctly.
\end{proof}

\begin{lemma}
    \label{wqo-implies-termination:lemma}
    Let $f \colon \Sigma^* \to \Nat$, and $k \in \Nat$ be such that
    every infinite, $\prefleq$-increasing sequence is \kl{good}
    in $(\Sigma^*, \resleq{f}{k})$
    (or equivalently, such that the relation $(\prefleq \Rightarrow \resleq{f}{k})$
    is \kl{well}).
    Then, \cref{residual:algo} terminates on the input $(f,k)$.
    \proofref{wqo-implies-termination:lemma}
\end{lemma}
\begin{proof}
    Assume towards a contradiction that
    \cref{residual:algo} does not terminate.
    Then, the \texttt{else} branch in the \texttt{while loop}
    must be taken infinitely often.
    This means that the set $Q$ of states grows arbitrarily large.

    Let us write $\seqof{Q_i}{i \in \Nat}$ for the set of states $Q$ at step
    $i$ of the execution of \cref{residual:algo}. Applying
    \cref{q-o-prefix-cool:fact}, we know that for all $i \in \Nat$, $Q_i$ is
    \kl{downwards closed} for $\prefleq$. Let us write $Q_\infty \defined
    \bigcup_{i \in \Nat} Q_i$. The set $Q_\infty$ is infinite, and is
    \kl{downwards closed} for $\prefleq$. As a consequence, it is an infinite
    tree with a finite branching (at most $\card{\Sigma}$), and has an infinite
    branch $\seqof{u_j}{j \in \Nat}$ thanks to König' s lemma.

    Let us prove that this infinite branch is a \kl{bad sequence} for the
    ordering $\resleq{f}{k}$.
    Let $j < p$, and assume by contradiction that $u_j \resleq{f}{k} u_p$. We
    know that $u_j \in Q_j$ and $u_p \in Q_p$. Then, at step $p-1$ of the
    algorithm, $u_j \in Q_{p-1}$, since $u_j \in Q_j \subseteq Q_{p-1}$.
    Because $u_j \prefleq u_p$ and $u_j \resleq{f}{k} u_p$,
    \cref{residual:algo} must take the \texttt{if} branch at step $p-1$. As a
    consequence, $u_p \not\in Q_{p}$, which is absurd.

    We have proven that the infinite branch is a \kl{bad sequence}
    for $\resleq{f}{k}$, which contradicts the assumption.
    Hence, \cref{residual:algo} must terminate.
\end{proof}



\begin{lemma}
    \label{n-poly-k-implies-wqo:lemma}
    Let $k \in \Nat$, and let $f \in \NPoly[k]$.
    Then, $(\Sigma^* \resleq{f}{k})$ is a \kl{well-quasi-ordering}.
\end{lemma}
\begin{proof}
    Because $f \in \NPoly[k]$, there exists
    a tuple $\vec{x}$ of first order free variables,
    $\MSO$ formulas $\seqof{\psi_i(\vec{x})}{1 \leq i \leq n}$,
    and positive coefficients $\seqof{m_i}{1 \leq i \leq n}$,
    such that
    $f = \sum_{i = 1}^n m_i \times \vcount{\varphi_i(\vec{x})}$
    \cite[Theorem 5.15]{DOUE23}.

    Let $q$ be the maximal quantifier rank of formulas $\seqof{\psi_i}{1 \leq i
    \leq n}$. To a word $u \in \Sigma^*$, we associate the vector $\MSO^q(u)$
    that maps an $\MSO$-type with $\ell \leq |\vec{x}|$ free variables to the
    number of realizations of this type in $u$.

    Let $u, v \in \Sigma^*$ such that $\MSO^q(u) \leq \MSO^q(v)$, which means
    that every $\MSO$ type (of quantifier rank $q$ and with at most $n$ free
    variables) has at least as many realizations in $v$ than it has in $u$.
    Remark that by the compositionality of $\MSO$ over words (for instance, see
    the Feferman-Vaught theorem \cite{FEVAU59,MAKOW04}), for all $\MSO^q$ types
    $t(\vec{x})$, there are finitely many $\MSO^q$ types $t_l^j(\vec{y_i}),
    t_r^j(\vec{z_i})$ with $\vec{x} = \vec{y_i} \uplus \vec{z_i}$
    for $1 \leq j \leq N_0$, such that for every
    tuple $\vec{a}$ of elements in a word $uv$, $\MSO^q(\vec{a} / uv) =
    t(\vec{x})$ if and only if there exists $1 \leq j \leq N_0$,
    such that $\vec{a} = \vec{b} \uplus \vec{c}$,
    $\MSO^q(\vec{b} / u) =
    t_l^j(\vec{y_i})$, and $\MSO^q(\vec{c} / v) = t_r^j(\vec{z_i})$.
    We write $t = t_l \odot t_r$ to signify
    that $\MSO^q(\vec{bc} / uv) = t$
    if and only if $\MSO^q(\vec{b}/u) = t_l$
    and $\MSO^q(\vec{c}/v) = t_r$.

    As a consequence, if $\MSO^q(u) \leq \MSO^q(v)$, then 
    for all $w \in \Sigma^*$:
    \begin{align*}
        & f(vw) - f(uw) \\
        &= 
        \sum_{i = 1}^n m_i
        \left[
            \vcount{\phi_i(\vec{x})} (vw) -
            \vcount{\phi_i(\vec{x})} (uw)
        \right] \\
        &= 
        \sum_{i = 1}^n
        m_i
            \sum_{\phi_i \in t(\vec{x})}
        \left[
            \vcount{t(\vec{x})}(vw)
            -
            \vcount{t(\vec{x})}(uw)
        \right] \\
        &= 
        \sum_{i = 1}^n
        m_i
        \sum_{1 \leq j \leq N_0}
        \sum_{\phi_i \in t_l^j(\vec{y}) \odot t_r^j(\vec{z})}
        \underbrace{
        \left[
            \vcount{t_r^j(\vec{y})}(v)
            -
            \vcount{t_r^j(\vec{y})}(u)
        \right] 
    }_{ \in \Nat }
            \times 
            \vcount{t_l^j(\vec{z})}(w)
    \end{align*}

    We have proven that if $\MSO^q(u) \leq \MSO^q(v)$, then $u \resleq{f}{k}
    v$. Recall that $\Nat^p$ is a \kl{well-quasi-ordering} when endowed with
    the product ordering, and therefore that $\setof{\MSO^q(u)}{u \in
    \Sigma^*}$ is a \kl{well-quasi-ordering}.

    Let $\seqof{u_i}{i \in \Nat}$ be an infinite sequence of $\Sigma^*$.
    Without loss of generality, one can assume that for all $i \neq j$, $u_i
    \equiv_k u_j$, i.e., that the difference $\app{f}{u_i} - \app{f}{u_j}$
    belongs to $\ZPoly[k-1]$, since the latter has finite index. Thanks to the
    above remarks, there exists $i < j$ such that $\MSO^q(u_i) \leq
    \MSO^q(u_j)$. As a consequence, $g \defined \app{f}{u_j} - \app{f}{u_i} \in
    \NPoly$, and therefore $g \in \NPoly[k-1]$. We have proven that there
    exists $i < j$ such that $u_i \resleq{f}{k} u_j$.
\end{proof}

\begin{theorem}
    \label{non-commutative-npoly:thm}
    Let $f \in \ZPoly$ be a non-negative function, 
    and $k \in \Nat$,
    the following are equivalent:
    \begin{enumerate}
        \item \label{n-poly-1-transd:item} $f$ is \kl{computed}
            by a \kl{$\NPoly[k-1]$-transducer};
        \item \label{n-poly-k:item} $f \in \NPoly[k]$;
        \item \label{n-poly-wqo:item} $(\Sigma^*, \resleq{f}{k})$ is a
            \kl{well-quasi-ordering};
        \item \label{n-poly-well:item} every $\prefleq$-increasing sequence
            of $\Sigma^*$  is a \kl{good sequence}
            for $\resleq{f}{k}$;
        \item \label{n-poly-residual:item} The
            \kl{$k$-residual transducer}
            of 
            $f$ exists.
    \end{enumerate}
    If $f$ is \kl{commutative}, the  
    properties are decidable, and the conversions effective.
\end{theorem}
\begin{proofof}{non-commutative-npoly:thm}
    \cref{n-poly-1-transd:item} implies \cref{n-poly-k:item} by
    definition. Then,
    \cref{n-poly-k:item} implies \cref{n-poly-wqo:item} by
    \cref{n-poly-k-implies-wqo:lemma}.
    The implication \cref{n-poly-wqo:item} $\Rightarrow$ \cref{n-poly-well:item}
    is obvious.
    Then, \cref{wqo-implies-termination:lemma} proves
    that \cref{n-poly-well:item} implies \cref{n-poly-residual:item}.
    Finally, because a \kl{$k$-residual transducer} is a \kl{$\NPoly[k-1]$-transducer},
    \cref{n-poly-residual:item} implies \cref{n-poly-1-transd:item}.
\end{proofof}

\AP Unfortunately, the \kl{residual transducer} does not seem to provide an
algorithm to decide $\NSF$ inside $\NPoly$ in the general setting. While we can
prove that for functions in $\NPoly[0]$, aperiodicity is equivalent to the
absence of counters in the \kl{residual transducer} of the function (see
\cref{aperiodic-iff-residual:lem}), this result does not generalize to higher
growth rates, as witnessed by \cref{non-aperiodic-residual-transd:ex}, which
suggests that a more sophisticated object is needed to observe aperiodicity. In
the spirit of the characterization of $\NPoly$ based the $(\resleq{f}{k})$
quasi-ordering (\cref{non-commutative-npoly:thm}), we introduce the notion of
\intro{aperiodic ordering} of $\Sigma^*$ as follows: $(\Sigma^*, \leq)$ is
\reintro[aperiodic ordering]{aperiodic} whenever for all $u, w \in \Sigma^*$,
there exists $N_0 \in \Nat$, such that the sequence $\seqof{uw^n}{n \geq N_0}$
is increasing. This leads to the following
\cref{sf-no-periods-on-sequences:conj}, of which the easy implication is
already known to hold (\cref{sf-no-periods-on-sequences:lemma}), and requires
the introduction of the \emph{star-free variant} $(\intro*\resleqsf{f}{k})$ of
$(\resleq{f}{k})$, defined by $u \reintro*\resleqsf{f}{k} v$ whenever
$(\app{f}{v} - \app{f}{u}) \in \NSF[k-1]$.
 


\begin{lemma} 
    \label{aperiodic-iff-residual:lem}
    Let $f \in \NPoly[0]$. Then,
    $f \in \NSF$ if and only if 
    $f \in \ZSF$, if and only if
    $f$ is \kl{ultimately polynomial}, if and only if 
    the \kl{$0$-residual transducer} of $f$ is \kl{counter-free}.
    \proofref{aperiodic-iff-residual:lem}
\end{lemma}
\begin{proofof}{aperiodic-iff-residual:lem}
    It is clear that $\NSF \subseteq \ZSF$, and known that if $f \in \ZSF$
    then it is \kl{ultimately polynomial}. Furthermore, if the \kl{$0$-residual
    transducer} of $f$ is \kl{counter-free}, then $f \in \NSF$
    by definition of $\NSF$.

    Assume that $f$ is \kl{ultimately polynomial}, let us prove that the
    \kl{$0$-residual transducer} of $f$ is \kl{counter-free}. 
    Note that because $f \in \NPoly[0]$,
    $u \resleq{f}{0} v$ if and only if $\app{f}{u} = \app{f}{v}$.
    In particular, in a \kl{$0$-residual transducer} of $f$,  two states that
    represent the same residual must be incomparable for the prefix relation.

    Let $(q,w^n)$ be
    a counter with $n \geq 1$. This means that $\delta(q, w^n) = q$ in the
    automaton, and implies that $q \resleq{f}{0} qw^n$, hence that $\app{f}{q}
    = \app{f}{qw^n}$. Because $f$ is \kl{ultimately polynomial},
    we know that $\app{f}{qw^n} = \app{f}{qw^{n+1}}$,
    hence that $\app{f}{qw} = \app{f}{q}$.

    Let us write $t \defined \delta(q,w) = \delta(q,w^{n+1})$. We know that
    $\app{f}{q} = \app{f}{t}$. Assume by contradiction that $t$ and $q$ are
    incomparable for the prefix relation. Let us split $w = w_1 w_2$ where
    $w_1$ is the shortest prefix of $w$ such that $s_0 \defined \delta(q,w_1)$
    is an ancestor of $q$ and of $t$ for the prefix relation, it must exist
    because $\delta(q,w_1 w_2) = t$.

    Now, consider $s_1 \defined \delta(t, w_1)$. Assume by contradiction that
    $s_0$ is not comparable with $s_1$ for the prefix relation. Then, consider
    the smallest prefix $v$ of $w_1$ such that $\delta(t, v)$ is a strict
    prefix of $s_0$. It must exist, otherwise $s_0$ is always a prefix of
    $s_1$. Because $\app{f}{t} = \app{f}{q}$, we conclude that $\app{f}{tv} =
    \app{f}{qv}$. However, this contradicts the minimality of $w_1$, since
    $\delta(t,v)$ is an ancestor of $q$ and $t$.

    We have proven that $s_0$ and $s_1$ are comparable, hence they are equal,
    since $\app{f}{s_1} = \app{f}{t w_1} = \app{f}{q w_1} = \app{f}{s_0}$.
    Finally, we have proven that $\delta(q, w_1) = s_0$, $\delta(s_0, w_2) =
    t$, and $\delta(s_0, w_2) = \delta(t, w_1w_2) = q$ which is absurd.
    As a consequence $t$ and $q$ were comparable for the prefix relation,
    hence equal, and therefore $\delta(q, w) = q$.
\end{proofof}

\begin{example}
    \label{non-aperiodic-residual-transd:ex}
    Let us define
    $\BadExKo(\varepsilon) = 1$,
    $\BadExKo(a) = 0$,
    $\BadExKo(a^2) = 1$,
    and $\BadExKo(a^n) = n - 3$ for all $n \geq 3$.
    The \kl{$0$-residual transducer} of $\BadExKo$ has a \kl{counter} and two states.
    Furthermore,
    every \kl{$\NPoly[0]$-transducer} with two states contains a \kl{counter}.
\end{example}


\begin{lemma}
    \label{sf-no-periods-on-sequences:lemma}
    Let $k \in \Nat$, and $f \in \NPoly[k]$. If $f \in \NSF[k]$, then
    $(\Sigma^*, \resleqsf{f}{k})$ is an
    \kl[aperiodic ordering]{aperiodic} \kl{well-quasi-ordering}.
    \proofref{sf-no-periods-on-sequences:lemma}
\end{lemma}
\begin{proofof}{sf-no-periods-on-sequences:lemma}
    Let $f \in \NSF[k]$, $q \in \Nat$, and 
    write $f = \sum_{i=1}^n m_i \times \vcount{\phi_i(\vec{x})}$, where
    $\phi_i \in \FO$ has quantifier rank at most $q$
    and $\card{\vec{x}} = k$
    \cite[Theorem 7.10]{DOUE23}.

    As in the proof of \cref{n-poly-k-implies-wqo:lemma}, we are going to
    assign a tuple of integers to a word $u \in \Sigma^*$ by counting the
    number of realizations of each $\FO^q$ type of at most $k$ variables in
    $u$. To that end, let us write $\FO^q(u)$ this vector.

    First, let us notice that it suffices to prove that for some $n \in \Nat$,
    $\FO^q(uw^n) \leq \FO^q(uw^{n+1})$ to conclude, since $\app{f}{uw^{n+1}} -
    \app{f}{uw^n}$ will be obtained as a positive combination of counting
    first-order types in the argument.

    Let $t$ be a first order type with at most $k$ free variables and
    quantifier rank at most $q$. The map $g_t \colon X \mapsto
    \vcount{t}(uw^X)$ is a \kl{commutative} \kl{star-free $\Nat$-polyregular
    function}. As a consequence, there exists $N_0$ and a polynomial $P \in
    \CorrectPoly$ such that for all $X \geq N_0$, $g_t(X) = P(X)$. Now, because
    $P \in \CorrectPoly$, there exists a $K \in \Nat$ such that
    $\translate{K}(\Diff{1}{P}) \in \Nat[X]$
    (\cref{derivation-translation:lem}), and in particular $g_t(X + N_0 + K+1)
    - g_t(X + N_0 + K) \in \Nat$, for all $X \geq 0$.

    Because there are finitely many non-equivalent $\FO^q$ types with at most 
    $k$ free variables, we can take the maximum of the $K$'s obtained for each 
    of those, and conclude.
\end{proofof}

\begin{conjecture}
    \label{sf-no-periods-on-sequences:conj}
    The implication of \cref{sf-no-periods-on-sequences:lemma} is actually an equivalence.
    %For all $k \in \Nat$ and $f \colon \Sigma^* \to \Rel$,
    %$f \in \NSF[k]$ if and only if $(\Sigma^*, \resleqsf{f}{k})$ is an \kl[aperiodic ordering]{aperiodic}
    %\kl{well-quasi-ordering}.
\end{conjecture}

% bibliographies
\bibliographystyle{plainurl}
\bibliography{papers.bib}

% appendices
\appendix
\input{src/appendix}

\end{document}
